name: ci

on:
  schedule:
    - cron: "0 6 * * 3"
  workflow_dispatch:
    inputs:
      arch:
        description: 'Architecture of WSA'
        required: true
        type: choice
        options:
        - 'x64'
        - 'arm64'
      release-type:
        description: 'Release type of WSA'
        required: true
        type: choice
        options:
        - 'retail'
        - 'RP'
        - WIS
        - WIF
      magisk-ver:
        description: 'Release type'
        required: true
        type: choice
        options:
        - 'retail'
        - 'RP'
        - WIS
        - WIF

      root:
        description: 'root Type'
        required: true
        type: choice
        options:
        - 'none'
        - 'magisk'
      release:
        description: 'release version'
        required: true
        type: choice
        options:
        - 'RP'
        - 'retail'

jobs:
  build:

    runs-on: ubuntu-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v3
    - name: Get Magisk alpha
      run: |
        mkdir download
        curl https://raw.githubusercontent.com/vvb2060/magisk_files/alpha/app-release.apk -o download/app-debug.apk
    - name: Install Dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y whiptail setools lzip wine winetricks patchelf e2fsprogs python3-pip aria2 p7zip-full attr
        pip list --disable-pip-version-check | grep -E "^requests " >/dev/null 2>&1 || python3 -m pip install requests
        winetricks list-installed | grep -E "^msxml6" >/dev/null 2>&1 || winetricks msxml6 || abort

    - name: Clone MagiskOnWSALocal source code
      run: |
        git clone --depth 1 https://github.com/LSPosed/MagiskOnWSALocal.git wsaworkdir

    - name: Build
      working-directory: wsaworkdir
      run: |
        sudo ./scripts/build.sh --arch ${{ inputs.arch }} --remove-amazon --compress --compress-format 7z --magisk-custom --release-type WIF
    - uses: actions/upload-artifact@v3
      with:
        name: MagiskOnWSA
        path: output

    - name: Package
      run: 7z a MagiskOnWSA.7z output
    - name: Get current time
      uses: srfrnk/current-time@master
      id: current-time
      with:
        format: YYYY.MM.DD
    - name: archive
      uses: softprops/action-gh-release@v1
      with:
        name: archive-${{ steps.current-time.outputs.formattedTime }}
        tag_name: archive-${{ steps.current-time.outputs.formattedTime }}
        files: MagiskOnWSA.7z
