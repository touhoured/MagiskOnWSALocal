name: ci

on:
  schedule:
    - cron: "0 6 * * 3"
  workflow_dispatch:
    inputs:
      arch:
        description: Architecture of WSA
        required: true
        type: choice
        default: x64
        options:
        - 'x64'
        - 'arm64'
      release-type:
        description: Release type of WSA
        required: true
        default: retail
        type: choice
        options:
        - 'retail'
        - 'RP'
        - WIS
        - WIF
      magisk:
        description: Magisk
        required: true
        type: choice
        default: alpha
        options:
        - official
        - alpha
        - delte
      magisk-ver:
        description: Magisk version
        required: true
        type: choice
        default: stable
        options:
        - stable
        - beta
        - canary
        - debug
        - release
      gapps-brand:
        description: GApps brand
        required: true
        type: choice
        default: MindTheGapps
        options:
        - OpenGApps
        - MindTheGapps
        - none
      gapps-variant:
        description: GApps brand
        required: true
        type: choice
        default: pico
        options:
        - super
        - stock
        - full
        - mini
        - nano
        - pico
        - tvstock
        - tvmini
      root-sol:
        description: Root solution
        required: true
        type: choice
        default: magisk
        options:
        - none
        - magisk
      # compress-format:
      #   description: Compress format of output file
      #   required: true
      #   type: choice
      #   default: 7z
      #   options:
      #   - 7z
      #   - xz
      #   - zip
      # remove-amazon:
      #   description: Remove Amazon Appstore from the system
      #   required: true
      #   default: true
      #   type: boolean
      # magisk-custom:
      #   description: Install custom Magisk
      #   required: true
      #   default: true
      #   type: boolean
      # debug:
      #   description: Debug build mode
      #   required: true
      #   default: true
      #   type: boolean
      # nofix-props:
      #   description: No fix "build.prop"
      #   required: true
      #   default: true
      #   type: boolean


jobs:
  build:

    runs-on: ubuntu-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v3
    - name: Get Magisk alpha
      run: |
        mkdir download
        curl https://raw.githubusercontent.com/vvb2060/magisk_files/alpha/app-release.apk -o download/app-debug.apk
    - name: Install Dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y whiptail setools lzip wine winetricks patchelf e2fsprogs python3-pip aria2 p7zip-full attr
        pip list --disable-pip-version-check | grep -E "^requests " >/dev/null 2>&1 || python3 -m pip install requests
        winetricks list-installed | grep -E "^msxml6" >/dev/null 2>&1 || winetricks msxml6 || abort

    - name: Clone MagiskOnWSALocal source code
      run: |
        git clone --depth 1 https://github.com/LSPosed/MagiskOnWSALocal.git wsaworkdir

    - name: Build
      working-directory: wsaworkdir
      run: |
        sudo ./scripts/build.sh --arch ${{ inputs.arch }} --release-type ${{ inputs.release-type }} --gapps-brand ${{ inputs.gapps-brand }} --gapps-variant ${{ inputs.gapps-variant }} --root-sol ${{ inputs.root-sol }}

    - uses: actions/upload-artifact@v3
      with:
        name: MagiskOnWSA
        path: output

    - name: Get current time
      uses: srfrnk/current-time@master
      id: current-time
      with:
        format: YYYY.MM.DD
    - name: archive
      uses: softprops/action-gh-release@v1
      with:
        name: archive-${{ steps.current-time.outputs.formattedTime }}
        tag_name: archive-${{ steps.current-time.outputs.formattedTime }}
        files: output/*.7z
